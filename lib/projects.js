#! /usr/bin/env node
"use strict";function renderProject(a,b){if(void 0===b&&(b="project:"),a){var c=a.toJSON();if(c.author){var d=c.author;delete c.author,c.author=d.displayName}c.id;delete c.id,delete c.script,delete c.packageJson,outputJson||console.log(b,a.getLinkUrl()),console.log(c)}}function download(a,b){void 0===b&&(b=!1),new Download({extract:b}).get(a.getDownloadLinkUrl()).dest(b?a.getFileBaseName():".").rename(function(c){return b?c:(c.basename=a.getFileBaseName(),c.extname=a.getFileExtension(),c)}).run(function(c,d){return c?void console.error(c):void(outputJson?console.log(b?{extracted:a.getFileBaseName()}:{downloaded:a.getFileName()}):console.log(b?"extracted: "+a.getFileBaseName():"downloaded: "+a.getFileName()))})}function readPackageJson(a,b){var c=a.dir||".",d=path.resolve(c);d+=d.length>1?path.sep:"",doReadPackageJson(d,b)}function doReadPackageJson(a,b){fs.readFile(a+"package.json","utf8",function(c,d){if(c)return outputJson?console.error({error:c.message}):console.error(c.message),b(null,a);var e;try{e=JSON.parse(d)}catch(f){return outputJson?console.error({error:f.message||"local package parse error"}):console.error(f.message||"local package parse error"),b(null,a)}b(e,a)})}function createProjectInfo(a,b,c,d){if(void 0===d&&(d=!0),!a)return c(null);var e={name:"test",description:"This Node.js project is created by f3.js (alpha release)\r  - for further details on f3.js, please visit http://f3js.org.",main:"index.js",dependencies:{f3js:"don't care :)",underscore:"^1.8.3"},author:"",license:"ISC"},f=b+(a.main||e.main);fs.readFile(f,"utf8",function(b,g){if(b||!g)return outputJson?console.error({error:"main code not found: "+f}):console.error("main code not found:",f),c(null);if(a.name===e.name&&delete a.name,a.description===e.description&&delete a.description,delete a.main,a.dependencies){var h=a.dependencies;h.f3js&&delete h.f3js,h.underscore&&h.underscore===e.dependencies.underscore&&delete h.underscore,_.keys(h).length<=0&&delete a.dependencies}if(a.author===e.author&&delete a.author,a.license===e.license&&delete a.license,!a.f3js){var i={nameJa:a.name,photoUrl:a.photoUrl,logJa:a.description,isUserEdit:!1,isPrivate:!!a["private"],script:g};delete a.name,delete a.photoUrl,delete a.description,delete a["private"],i.packageJson=a;var j=new models.Project(i);return void c(j)}var k=new models.Variant(a.f3js),l=k.projectId>=0?k.projectId:k.projectSourceId;projects.read(l,function(b){return b?(b.nameJa=a.name||k.projectNameJa||b.nameJa,b.photoUrl=a.photoUrl||b.photoUrl,b.logJa=a.description||b.logJa,b.isUserEdit=!1,b.isPrivate=b.isPrivate&&!!a["private"],b.script=g,b.name=k.projectName||b.name,d&&(b.sourceId=b.id,b.sourceOriginId=b.sourceOriginId),void c(b,k)):(outputJson?console.error({error:"project not found"}):console.error("project not found"),c(null))})})}function updatePackageJson(a,b,c){projects.readVariant(b,function(b){var d=b.toJSON();d.author&&delete d.author,d.originalAuthor&&delete d.originalAuthor,delete d.name,delete d.log,delete d.script,delete d.parametersJson,delete d.contentType,delete d.extension,delete d.packageJson,delete d.accessCount,doReadPackageJson(a,function(b){b.f3js=d;var e=JSON.stringify(b,null,"  ");fs.writeFile(a+"package.json",e,{encoding:"utf8"},function(a){return a?void(outputJson?console.error({error:"failed to update local package.json: "+a.message}):console.error("failed to update local package.json:",a.message)):void c()})})})}function installEdison(a,b){void 0===b&&(b=null),doReadPackageJson(a,function(c){if(c){if(!c.f3js)return void(outputJson?console.error({error:"unsupported project: not registered to f3js.org"}):console.error("unsupported project: not registered to f3js.org"));outputJson||console.log("copying files from",a),scpClient.scp(a,platform,function(c){return c?void(outputJson?console.error({error:c.message}):console.error(c.message)):(outputJson?console.log({success:"copied files from "+a}):console.log("installed!"),void(b&&b()))})}})}function execEdison(a){var b=new ssh2.Client;b.on("ready",function(){function c(a,c){if(a)throw a;var d="",e="";c.on("close",function(a,c){b.end(),global.self.debug&&console.log("connection closed with code: "+a+", signal: "+c),process.exit(0)}).on("data",function(a){var b=a.toString(),c=b.split("\n");d.length>0&&0===d.indexOf(c[0])&&(d=d.substring(c[0].length),c.shift(),b=c.join("\n")),process.stdout.write(b)}).stderr.on("data",function(a){process.stderr.write(a)}),process.stdin.on("data",function(a){var b=a.toString(),f=b.indexOf("\n");f>=0?(e+=b.substring(0,f),d=e,e="",c.write(d)):e+=b})}return global.self.debug&&console.log("connected to "+platform.host+(platform.port?":"+platform.port:"")),"string"==typeof a&&a.length>0?void b.exec(a,c):void b.shell(!0,c)}).connect(platform)}var _=require("underscore"),fs=require("fs"),path=require("path"),readline=require("readline"),Download=require("download"),utils=require("./utils"),models=require("./connector/models"),projects=require("./connector/api/projects"),ssh2=require("ssh2"),scpClient=require("scp2"),doList=null,doGet=null,doDownload=null,doDownloadVar=null,doInfo=null,doSave=null,doSaveVar=null,doInstall=null,doExec=null,platform,outputJson,program=utils.init(function(a){a.command("list").description("list up projects").option("-o, --offset <n>","offset index value",parseInt).action(function(a){doList=function(){var b={};a.offset&&(b.startId=a.offset),projects.list(function(a,b){return a?void(outputJson?(console.log("{ results:{",b,"}, entries:{"),_.each(a,function(a,b){b>0&&console.log(", "),renderProject(a)}),console.log("} }")):(console.log("next id:",b.nextStartId?b.nextStartId:-1),_.each(a,function(a){return renderProject(a)}))):void(outputJson?console.error({error:"projects not found"}):console.error("projects not found"))},b)}}),a.command("get <id>").description("get project information").action(function(a){doGet=function(){return a?void projects.read(a,function(a){return a?void renderProject(a):void console.log(null)}):void console.log(null)}}),a.command("download <id>").description("download a project archive").option("-e, --extract","extract the archive").action(function(a,b){doDownload=function(){if(!a)return void(outputJson?console.error({error:"download failed: no id specified"}):console.error("download failed:","no id specified"));var c=!!b.extract;projects.read(a,function(a){if(!a)return void(outputJson?console.error({error:"download failed: project not found"}):console.error("download failed:","project not found"));var b=new models.Variant({script:a.script,projectId:a.id,parametersJson:{},contentType:models.Variant.PROGRAM_NODEJS,isPrivate:a.isPrivate});b=b.toJSON(),b.extension="tar",projects.createVariant(b,function(a){return a?void download(a,c):void(outputJson?console.error({error:"download failed: unknown error"}):console.error("download failed:","unknown error"))})})}}),a.command("info").description("show information of the local project").option("-d, --dir [dir]","directory path").action(function(a){doInfo=function(){return readPackageJson(a,function(a,b){return createProjectInfo(a,b,function(a){return renderProject(a)},!1)})}}),a.command("save").description("save the local project in f3js.org").option("-d, --dir [dir]","project directory path").option("-p, --pdf","download PDF").action(function(a){doSave=function(){return readPackageJson(a,function(b,c){return createProjectInfo(b,c,function(b,d){function e(){projects.create(f,function(b,e){return b?void(outputJson&&console.error(b)):(renderProject(e,g?"project created:":"project updated:"),d.sourceId=d.id,delete d.id,d.projectId=e.id,d.projectSourceId=-1,d.script=e.script,d.packageJson=e.packageJson,d.contentType=models.Variant.LAYOUT_LASERCUT,d.isPrivate=e.isPrivate,void projects.createVariant(d.toJSON(),function(b){return updatePackageJson(c,b.id,function(){a.pdf&&(d.id=b.id,download(d))})}))},outputJson)}if(b){var f=b.toJSON();delete f.id,delete f.author,delete f.accessCount,delete f.createdDate;var g=!f.sourceOriginId||f.sourceOriginId<0;return g?e():void projects.findDescendant(b.sourceOriginId,function(a){if(!a||a.id===b.id)return e();var c=readline.createInterface({input:process.stdin,output:process.stdout});c.question("[36mNEWER PROJECT DATA FOUND ON F3JS.ORG:[39m if you proceed to save the project, the project data (id:[33m"+a.id+"[39m) on f3js.org will be overwritten by the local copy based on the older data (id:[33m"+b.id+"[39m). Is it OK to save? [36m(Y/n)[39m ",function(b){0===b.toLowerCase().indexOf("y")&&(f.sourceId=a.id,e()),c.close(),process.stdin.destroy&&process.stdin.destroy()})})}})})}}),a.command("render").description("render the local project as a PDF or SVG file").option("-d, --dir [dir]","project directory path").option("-f, --format [extension]","rendering format (pdf or svg)").action(function(a){doSaveVar=function(){return readPackageJson(a,function(b,c){return createProjectInfo(b,c,function(b,d){return d?(d.sourceId=d.id,delete d.id,d.script=b.script,d.packageJson=b.packageJson,d.contentType=models.Variant.LAYOUT_LASERCUT,d.projectId>=0&&(d.projectSourceId=d.projectId,d.projectId=-1),void projects.createVariant(d.toJSON(),function(b){return b?void updatePackageJson(c,b.id,function(){a.format&&"svg"===a.format?b.extension="svg":b.extension="pdf",download(b)}):void(outputJson?console.error({error:"download failed: unknown error"}):console.error("download failed:","unknown error"))})):void(outputJson?console.error({error:"unsupported project: not registered to f3js.org"}):console.error("unsupported project: not registered to f3js.org"))})})}}),a.command("install").description("install the project data on the target").option("-d, --dir [dir]","project directory path").action(function(a){doInstall=function(){return readPackageJson(a,function(a,b){return"undefined"==typeof platform?void(outputJson?console.error({error:"target not specified - specify it with -p or --platform"}):console.error("target not specified - specify it with -p or --platform")):platform?"edison"===platform.type?void installEdison(b):void(outputJson?console.error({error:"unsupported target:"+platform.type}):console.error("unsupported target:",platform.type)):void(outputJson?console.error({error:"target not specified correctly - specify it with -p or --platform"}):console.error("target not specified correctly - specify it with -p or --platform"))})}}),a.command("exec").description("execute a command on the target").option("-c, --command [command string]","command to be executed on the target").action(function(a){doExec=function(){return"undefined"==typeof platform?void(outputJson?console.error({error:"target not specified - specify it with -p or --platform"}):console.error("target not specified - specify it with -p or --platform")):platform?"edison"===platform.type?void execEdison(a.command):void(outputJson?console.error({error:"unsupported target:"+platform.type}):console.error("unsupported target:",platform.type)):void(outputJson?console.error({error:"target not specified correctly - specify it with -p or --platform"}):console.error("target not specified correctly - specify it with -p or --platform"))}})});platform=program.platform,outputJson=!!program.json,doList&&doList(),doGet&&doGet(),doDownload&&doDownload(),doDownloadVar&&doDownloadVar(),doInfo&&doInfo(),doSave&&doSave(),doSaveVar&&doSaveVar(),doInstall&&doInstall(),doExec&&doExec();/*! f3js-cli - v0.1.3 - 2016-07-11 */
