#! /usr/bin/env node
"use strict";function renderProject(a,b){void 0===b&&(b="project:");var c=a.toJSON();if(c.author){var d=c.author;delete c.author,c.author=d.displayName}c.id;delete c.id,delete c.script,delete c.packageJson,console.log(b,a.getLinkUrl()),console.log(c)}function download(a,b){void 0===b&&(b=!1),new Download({extract:b}).get(a.getDownloadLinkUrl()).dest(b?a.getFileBaseName():".").rename(function(c){return b?c:(c.basename=a.getFileBaseName(),c.extname=a.getFileExtension(),c)}).run(function(c,d){return c?void console.error(c):void console.log("downloaded:",b?a.getFileBaseName():a.getFileName())})}function readPackageJson(a,b){var c=a.dir||".",d=path.resolve(c);d+=d.length>1?path.sep:"",doReadPackageJson(d,b)}function doReadPackageJson(a,b){fs.readFile(a+"package.json","utf8",function(c,d){if(c)return console.error(c),b(null,a);var e;try{e=JSON.parse(d)}catch(f){return console.error(f.message||"local package parse error"),b(null,a)}b(e,a)})}function createProjectInfo(a,b,c){if(!a)return c(null);var d={name:"test",description:"This Node.js project is created by f3.js (alpha release)\r  - for further details on f3.js, please visit http://f3js.org.",main:"index.js",dependencies:{f3js:"don't care :)",underscore:"^1.8.3"},author:"",license:"ISC"},e=b+(a.main||d.main);fs.readFile(e,"utf8",function(b,f){if(b||!f)return console.error("main code not found:",e),c(null);if(a.name===d.name&&delete a.name,a.description===d.description&&delete a.description,delete a.main,a.dependencies){var g=a.dependencies;g.f3js&&delete g.f3js,g.underscore&&g.underscore===d.dependencies.underscore&&delete g.underscore,_.keys(g).length<=0&&delete a.dependencies}if(a.author===d.author&&delete a.author,a.license===d.license&&delete a.license,!a.f3js){var h={nameJa:a.name,photoUrl:a.photoUrl,logJa:a.description,isUserEdit:!1,isPrivate:!!a["private"],script:f};delete a.name,delete a.photoUrl,delete a.description,delete a["private"],h.packageJson=a;var i=new models.Project(h);return void c(i)}var j=new models.Variant(a.f3js),k=j.projectId>=0?j.projectId:j.projectSourceId;projects.read(k,function(b){return b?(b.nameJa=a.name||j.projectNameJa||b.nameJa,b.photoUrl=a.photoUrl||b.photoUrl,b.logJa=a.description||b.logJa,b.isUserEdit=!1,b.isPrivate=b.isPrivate&&!!a["private"],b.script=f,b.name=j.projectName||b.name,b.sourceId=b.id,b.sourceOriginId=b.sourceOriginId,void c(b,j)):(console.error("project not found"),c(null))})})}function updatePackageJson(a,b,c){projects.readVariant(b,function(b){var d=b.toJSON();d.author&&delete d.author,d.originalAuthor&&delete d.originalAuthor,delete d.name,delete d.log,delete d.script,delete d.parametersJson,delete d.contentType,delete d.archiver,delete d.packageJson,delete d.accessCount,doReadPackageJson(a,function(b){b.f3js=d;var e=JSON.stringify(b,null,"  ");fs.writeFile(a+"package.json",e,{encoding:"utf8"},function(a){return a?void console.error("failed to update local package.json:",a.message):void c()})})})}var _=require("underscore"),fs=require("fs"),path=require("path"),readline=require("readline"),Download=require("download"),utils=require("./utils"),models=require("./connector/models"),projects=require("./connector/api/projects"),doList=null,doGet=null,doDownload=null,doDownloadVar=null,doInfo=null,doSave=null,doSaveVar=null;utils.init(function(a){a.command("list").description("list up projects").option("-o, --offset <n>","Offset index",parseInt).action(function(a){doList=function(){var b={};a.offset&&(b.startIndex=a.offset),projects.list(function(a,b){a&&(console.log("next offset:",b.nextStartIndex?b.nextStartIndex:-1),_.each(a,function(a){return renderProject(a)}))},b)}}),a.command("get <id>").description("get project information").action(function(a){doGet=function(){return a?void projects.read(a,function(a){return a?void renderProject(a):void console.log(null)}):void console.log(null)}}),a.command("download <id>").description("download a project archive").option("-e, --extract","Extract the archive").action(function(a,b){doDownload=function(){if(!a)return void console.log("download failed:","no id specified");var c=!!b.extract;projects.read(a,function(a){if(!a)return void console.log("download failed:","project not found");var b=new models.Variant({script:a.script,projectId:a.id,parametersJson:{},contentType:models.Variant.PROGRAM_NODEJS,isPrivate:a.isPrivate});b=b.toJSON(),b.archiver="tar.gz",projects.createVariant(b,function(a){return a?void download(a,c):void console.log("download failed:","unknown error")})})}}),a.command("download-var <id>").description("download a variation of the project archive").option("-e, --extract","Extract the archive").action(function(a,b){doDownloadVar=function(){if(!a)return void console.log("download failed:","no id specified");var c=!!b.extract;projects.readVariant(a,function(a){return a?(a.contentType=models.Variant.PROGRAM_NODEJS,a.archiver="tar.gz",void download(a,c)):void console.log("download failed:","variant not found")})}}),a.command("info").description("show information of the local project").option("-d, --dir","Directory path").action(function(a){doInfo=function(){return readPackageJson(a,function(a,b){return createProjectInfo(a,b,function(a){return renderProject(a)})})}}),a.command("save").description("save the local project in f3js.org").option("-d, --dir","Directory path").option("-p, --pdf","Download PDF").action(function(a){doSave=function(){return readPackageJson(a,function(b,c){return createProjectInfo(b,c,function(b,d){function e(){projects.create(f,function(b,e){b||(renderProject(e,g?"project created:":"project updated:"),d.sourceId=d.id,delete d.id,d.projectId=e.id,d.projectSourceId=-1,d.script=e.script,d.packageJson=e.packageJson,d.contentType=models.Variant.LAYOUT_LASERCUT,d.isPrivate=e.isPrivate,projects.createVariant(d.toJSON(),function(b){return updatePackageJson(c,b.id,function(){a.pdf&&(d.id=b.id,download(d))})}))})}if(b){var f=b.toJSON();delete f.id,delete f.author,delete f.accessCount,delete f.createdDate;var g=!f.sourceOriginId||f.sourceOriginId<0;return g?e():void projects.findDescendant(b.sourceOriginId,function(a){if(a.id===b.id)return e();var c=readline.createInterface({input:process.stdin,output:process.stdout});c.question("[36mNEWER PROJECT DATA FOUND ON F3JS.ORG:[39m if you proceed to save the project, the project data (id:[33m"+a.id+"[39m) on f3js.org will be overwritten by the local copy based on the older data (id:[33m"+b.id+"[39m). Is it OK to save? [36m(Y/n)[39m ",function(b){0===b.toLowerCase().indexOf("y")&&(f.sourceId=a.id,e()),c.close(),process.stdin.destroy&&process.stdin.destroy()})})}})})}}),a.command("save-var").description("render the local project as a PDF file").option("-d, --dir","Directory path").action(function(a){doSaveVar=function(){return readPackageJson(a,function(a,b){return createProjectInfo(a,b,function(a,c){return c?(c.sourceId=c.id,delete c.id,c.script=a.script,c.packageJson=a.packageJson,c.contentType=models.Variant.LAYOUT_LASERCUT,c.projectId>=0&&(c.projectSourceId=c.projectId,c.projectId=-1),void projects.createVariant(c.toJSON(),function(a){return a?void updatePackageJson(b,a.id,function(){download(a)}):void console.log("download failed:","unknown error")})):void console.error("project not saved in f3js.org - save it first.")})})}})}),doList&&doList(),doGet&&doGet(),doDownload&&doDownload(),doDownloadVar&&doDownloadVar(),doInfo&&doInfo(),doSave&&doSave(),doSaveVar&&doSaveVar();/*! f3js-cli - v0.0.5 - 2016-07-05 */
